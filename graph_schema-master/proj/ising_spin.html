<!DOCTYPE html>
<html>
	<head>
		<meta content="utf-8" http-equiv="encoding">
	</head>
    <body>
    	<div id="viz">
    	</div>
    	<script src="lib/d3.js"></script>
    	<script type="text/javascript">
	    	xmlhttp = new XMLHttpRequest();
	    	xmlhttp.onload = function() {
		        var xmlDoc = xmlhttp.responseXML;
		        var nodesList = xmlDoc.getElementsByTagName("DevI");
		        var nodes = [];

		       	for (var i = 0; i < nodesList.length; i++) {
		       		var n = nodesList[i];
		       		var id = n.getAttribute("id");
		       		var type = n.getAttribute("type");
		       		var prop = JSON.parse("{" + n.childNodes[1].innerHTML + "}"); // gets the p element

		       		var node = { "id": id,
		       					"type": type,
		       					"p": prop }

		       		nodes.push(node);
		       	}

		       	var edgesList = xmlDoc.getElementsByTagName("EdgeI");
		        var edges = [];

		        for (var i = 0; i < edgesList.length; i++) {
		       		var n = edgesList[i];
		       		var reSource = /(.+):in/
		       		var reTarget = /-(.+):out/
		       		var path = n.getAttribute("path")
		       		var source = reSource.exec(path)[1];
		       		var target = reTarget.exec(path)[1];
		       		
		       		var edge = {"source": source,
		       					"target": target}

		       		edges.push(edge);
		       	}

		       	var data = {
		       		"nodes": nodes,
		       		"edges": edges
		       	}

		       	// TODO: sizing?
		       	var width = window.innerWidth;
		       	var height = window.innerHeight;

				var svg = d3.select("body")
					.append("svg")
					.attr("viewBox", "0 0 " + width + " " + height )
            		.attr("preserveAspectRatio", "xMidYMid meet");

				var simulation = d3.forceSimulation()
				    .force("link", d3.forceLink().id(function(d) { return d.id; }))
				    .force("charge", d3.forceManyBody())
				    .force("center", d3.forceCenter(width / 2, height / 2));

				var link = svg.append("g")
						    	.attr("class", "edges")
						    	.selectAll("line")
						    	.data(data.edges)
						    	.enter().append("line")
						      	.attr("stroke", "#cccccc");

				var node = svg.append("g")
							    .attr("class", "nodes")
							    .selectAll("circle")
							    .data(data.nodes)
							    .enter().append("circle")
							    .attr("r", 5)

				simulation.nodes(data.nodes)
      						.on("tick", ticked);

  				simulation.force("link")
      						.links(data.edges);

				function ticked() {
				    link
				        .attr("x1", function(d) { return d.source.x; })
				        .attr("y1", function(d) { return d.source.y; })
				        .attr("x2", function(d) { return d.target.x; })
				        .attr("y2", function(d) { return d.target.y; });

				    node
				        .attr("cx", function(d) { return d.x; })
				        .attr("cy", function(d) { return d.y; });
				  }

	        }
	        xmlhttp.open("GET","ising_spin_16_2.xml", true);
	        xmlhttp.send();

    	</script>
    </body>
</html>